<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Final Quiz</title>
<style>
/* ================================
   FULL SCREEN TARGET UI CSS
   ================================ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #ffffff;
    color: #1f2937;
    min-height: 100vh;
    overflow-x: hidden;
}

/* Main Container - Full Screen */
.quiz-wrapper {
    width: 100%;
    max-width: 100%;
    min-height: 100vh;
    background: white;
    padding: 40px;
    border-radius: 0;
    box-shadow: none;
}

.quiz-content-container {
    max-width: 1000px; 
    margin: 0 auto;
}

/* Header */
.quiz-header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e5e7eb;
}

.quiz-header h1 {
    color: #1f2937;
    font-size: 32px;
    margin-bottom: 10px;
}

.quiz-header p {
    color: #6b7280;
    font-size: 18px;
}

/* Question Blocks */
.question-block {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 30px;
    margin-bottom: 30px;
    transition: all 0.3s ease;
}

.question-block.correct {
    border-color: #10b981;
    background: #f0fdf4;
}

.question-block.incorrect {
    border-color: #ef4444;
    background: #fef2f2;
}

.question-number {
    color: #3b82f6;
    font-weight: 600;
    font-size: 18px;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.question-text {
    color: #1f2937;
    font-size: 18px;
    font-weight: 500;
    margin-bottom: 25px;
    line-height: 1.6;
}

/* Options */
.options {
    margin-top: 20px;
}

.options label {
    display: block;
    padding: 15px 20px;
    margin-bottom: 12px;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 16px;
}

.options label:hover {
    border-color: #3b82f6;
    background: #eff6ff;
}

.options input[type="checkbox"] {
    margin-right: 12px;
    cursor: pointer;
    width: 20px;
    height: 20px;
    transform: translateY(3px);
}

/* Fill-in-the-Blank */
.fill-blank-content {
    background: white;
    padding: 25px;
    border-radius: 6px;
    line-height: 2.8;
    font-size: 17px;
    border: 1px solid #e5e7eb;
}

.select-dropdown {
    padding: 8px 12px;
    border: 2px solid #3b82f6;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 500;
    background: white;
    cursor: pointer;
    margin: 0 5px;
    transition: all 0.2s ease;
}

.select-dropdown:hover {
    border-color: #2563eb;
    background: #eff6ff;
}

/* Commentary */
.commentary {
    margin-top: 25px;
    padding: 20px;
    background: #fef3c7;
    border-left: 5px solid #f59e0b;
    border-radius: 4px;
    animation: fadeIn 0.5s;
}

.commentary h4 {
    color: #92400e;
    font-size: 16px;
    margin-bottom: 8px;
    text-transform: uppercase;
    font-weight: 700;
}

/* Actions */
.quiz-actions {
    text-align: center;
    margin-top: 50px;
    padding-top: 30px;
    border-top: 1px solid #e5e7eb;
}

.btn-submit {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 15px 60px;
    font-size: 18px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
}

.btn-submit:hover {
    background: #2563eb;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(59, 130, 246, 0.4);
}

/* Results */
.results {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px;
    border-radius: 12px;
    text-align: center;
    margin-top: 40px;
    animation: slideUp 0.5s ease;
}

.results h2 {
    font-size: 36px;
    margin-bottom: 20px;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
</head>
<body>

<div class="quiz-wrapper">
    <div class="quiz-content-container">
        <div class="quiz-header">
            <h1>Final Quiz</h1>
            <p>Plug-in Charge Control System</p>
        </div>

        <div id="viewer">
            <p style="text-align:center; color:#666;">Loading quiz data...</p>
        </div>
    </div>
</div>

<script src="quiz-data.js"></script>
<script>
//  const quizData = quizData;

 if(!Array.isArray(quizData) || quizData.length === 0) {
    document.getElementById("viewer").innerHTML = '<p style="text-align:center; color:#666;">No quiz data available.</p>';
    } else {    
    renderQuiz();
    }

// Initialize Quiz on Load by fetching JSON
window.addEventListener("load", async () => {
    if (typeof LMSInitialize_ === "function") LMSInitialize_("");
    
   
});

window.addEventListener("beforeunload", () => { 
    if (typeof LMSCommit_ === "function") LMSCommit_(); 
});

function renderQuiz() {
    const viewer = document.getElementById("viewer");
    
    let html = `<div id="quiz-container">`;

    quizData.forEach((q, index) => {
        // Wrapper Block
        html += `<div class="question-block" id="qblock_${index}">
                    <div class="question-number">Question ${index + 1}</div>
                    <div class="question-text">${q.text}</div>`;
        
        if (q.type === "fill-blank") {
            // Fill in the blank logic
            let contentHtml = q.content;
            
            contentHtml = contentHtml.replace(/\[KEY(\d+)\]/gi, (match, keyNum) => {
                let keyStr = "key" + keyNum;
                let optionsList = [];
                if (Array.isArray(q.dropdownOptions)) {
                    optionsList = q.dropdownOptions; 
                } else if (q.dropdownOptions[keyStr]) {
                    optionsList = q.dropdownOptions[keyStr];
                }
                let optionsHtml = optionsList.map(opt => 
                    `<option value="${opt.value}">${opt.text}</option>`
                ).join("");
                
                return `<select id="key${keyNum}_q${index}" name="key${keyNum}_q${index}" class="select-dropdown">${optionsHtml}</select>`;
            });
            
            html += `<div class="fill-blank-content">${contentHtml}</div>`;
        } else {
            // Multiple Choice Logic
            html += `<div class="options">`;
            q.options.forEach((opt, oIndex) => {
                html += `<label><input type="checkbox" name="q${index}" value="${oIndex + 1}"> ${oIndex + 1}. ${opt}</label>`;
            });
            html += `</div>`;
        }

        // Feedback Logic
        html += `   <div class="commentary" style="display:none;">
                        <h4>ðŸ“‹ Commentary</h4>
                        <p>${q.feedback}</p>
                    </div>
                 </div>`;
    });

    // Close container and add Submit button
    html += `  </div>
               <div class="quiz-actions">
                 <button class="btn-submit" onclick="gradeQuiz()">Submit Quiz</button>
               </div>`;
    
    viewer.innerHTML = html;
}

function gradeQuiz() {
    let score = 0;
    let allAnswered = true;

    function getSelectedCheckboxes(name) {
        const chosen = Array.from(document.querySelectorAll(`input[name='${name}']:checked`)).map(e => e.value);
        chosen.sort();
        return chosen.join("|");
    }

    function getDropdownValue(id) {
        const el = document.getElementById(id);
        return el ? el.value : "";
    }

    // Check if everything is answered
    quizData.forEach((q, index) => {
        if (q.type === "fill-blank") {
            for (let key in q.correct) {
                let keyNum = key.replace("key", ""); 
                let val = getDropdownValue(`key${keyNum}_q${index}`);
                if (!val) allAnswered = false;
            }
        } else {
            let val = getSelectedCheckboxes(`q${index}`);
            if (!val) allAnswered = false;
        }
    });

    if (!allAnswered) {
        alert("Please answer all questions before submitting.");
        return;
    }

    // Calculate Score & Show Feedback
    quizData.forEach((q, index) => {
        let isCorrect = false;
        if (q.type === "fill-blank") {
            let allKeysCorrect = true;
            for (let key in q.correct) {
                let keyNum = key.replace("key", "");
                let val = getDropdownValue(`key${keyNum}_q${index}`);
                if (val !== q.correct[key]) allKeysCorrect = false;
            }
            isCorrect = allKeysCorrect;
        } else {
            let val = getSelectedCheckboxes(`q${index}`);
            isCorrect = (val === q.correct);
        }
        
        mark(`qblock_${index}`, isCorrect);
        if (isCorrect) score++;
    });

    // Handle SCORM & Results
    if (typeof LMSSetValue_ === "function") {
        if (score === quizData.length) {
            LMSSetValue_("cmi.core.score.raw", "100");
            LMSSetValue_("cmi.core.lesson_status", "passed");
            LMSCommit_();
            showCompletionMessage(score, quizData.length, true);
            
            setTimeout(() => {
                if (typeof LMSFinish_ === "function") LMSFinish_("");
                window.close();
            }, 3000);
        } else {
            let pct = Math.round((score / quizData.length) * 100);
            LMSSetValue_("cmi.core.score.raw", String(pct));
            LMSSetValue_("cmi.core.lesson_status", "incomplete");
            LMSCommit_();
            showCompletionMessage(score, quizData.length, false);
        }
    } else {
        // Fallback for non-SCORM environments
        showCompletionMessage(score, quizData.length, score === quizData.length);
    }
}

function mark(blockId, ok) {
    const block = document.getElementById(blockId);
    if (!block) return;
    
    block.classList.remove("correct", "incorrect");
    block.classList.add(ok ? "correct" : "incorrect");
    
    const comm = block.querySelector(".commentary");
    if (comm) comm.style.display = ok ? "none" : "block";
}

function showCompletionMessage(score, total, passed) {
    const viewer = document.getElementById("viewer");
    const pct = Math.round((score / total) * 100);
    
    let html = `<div class="results">
                    <h2>${passed ? 'ðŸŽ‰ Congratulations!' : 'ðŸ“š Keep Learning!'}</h2>
                    <p>Your Score: <strong>${score} / ${total}</strong></p>
                    <p>Percentage: <strong>${pct}%</strong></p>
                    <p>${passed ? 'You have passed the training.' : 'Please review the incorrect answers.'}</p>
                    ${!passed ? '<button class="btn-retry" onclick="location.reload()" style="background:white; color:#667eea; border:none; padding:10px 30px; border-radius:6px; cursor:pointer; margin-top:20px; font-weight:bold;">Retry</button>' : ''}
                </div>`;
                
    if(passed) {
        viewer.innerHTML = html;
    } else {
        window.scrollTo({ top: 0, behavior: "smooth" });
        let existingResult = document.querySelector('.results');
        if(existingResult) existingResult.remove();
        viewer.insertAdjacentHTML('afterbegin', html);
    }
}
</script>

</body>
</html>